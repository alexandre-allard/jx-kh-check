buildPack: none
dockerRegistryOwner: jenkinsxio
pipelineConfig:
  pipelines:
    pullRequest:
      pipeline:
        stages:
          - agent:
              image: golang:1.15
            name: cli
            options:
              containerOptions:
                resources:
                  limits:
                    cpu: 3
                    memory: 3072Mi
                  requests:
                    cpu: 2
                    memory: 2048Mi
            steps:
              - name: lint
                command: make lint
                image: golangci/golangci-lint
              - name: test-webhooks
                command: make test
                image: golang:1.15
                dir: /workspace/source/cmd/jx-webhooks
              - name: test-install
                command: make test
                image: golang:1.15
                dir: /workspace/source/cmd/jx-install
              - name: test-bot-token
                command: make test
                image: golang:1.15
                dir: /workspace/source/cmd/jx-bot-token
              - name: test-secrets
                command: make test
                image: golang:1.15
                dir: /workspace/source/cmd/jx-secrets
              - name: test-pod-status
                command: make test
                image: golang:1.15
                dir: /workspace/source/cmd/jx-pod-status
              - name: charts
                image: gcr.io/jenkinsxio/jx-cli
                command: make
                args:
                  - build
                dir: /workspace/source/charts/jx-kh-check
    release:
      pipeline:
        stages:
          - agent:
              image: gcr.io/jenkinsxio/builder-go
            name: chart
            steps:
              - name: build-webhooks
                command: make build
                image: golang:1.15
                dir: /workspace/source/cmd/jx-webhooks
              - name: build-and-push-webhooks
                image: gcr.io/kaniko-project/executor
                command: /kaniko/executor --context=/workspace/source/cmd/jx-webhooks --dockerfile=/workspace/source/cmd/jx-webhooks/Dockerfile --destination=gcr.io/$DOCKER_REGISTRY_ORG/jx-webhooks:$VERSION
                env:
                - name: NO_GOOGLE_APPLICATION_CREDENTIALS
                  value: "true"
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: ""
                - name: DOCKER_REGISTRY_ORG
                  value: jenkinsxio

              - name: build-install
                command: make build
                image: golang:1.15
                dir: /workspace/source/cmd/jx-install
              - name: build-and-push-install
                image: gcr.io/kaniko-project/executor
                command: /kaniko/executor --context=/workspace/source/cmd/jx-install --dockerfile=/workspace/source/cmd/jx-install/Dockerfile --destination=gcr.io/$DOCKER_REGISTRY_ORG/jx-install:$VERSION
                env:
                  - name: NO_GOOGLE_APPLICATION_CREDENTIALS
                    value: "true"
                  - name: GOOGLE_APPLICATION_CREDENTIALS
                    value: ""
                  - name: DOCKER_REGISTRY_ORG
                    value: jenkinsxio

              - name: build-jx-bot-token
                command: make build
                image: golang:1.15
                dir: /workspace/source/cmd/jx-bot-token
              - name: build-and-push-jx-bot-token
                image: gcr.io/kaniko-project/executor
                command: /kaniko/executor --context=/workspace/source/cmd/jx-bot-token --dockerfile=/workspace/source/cmd/jx-bot-token/Dockerfile --destination=gcr.io/$DOCKER_REGISTRY_ORG/jx-bot-token:$VERSION
                env:
                  - name: NO_GOOGLE_APPLICATION_CREDENTIALS
                    value: "true"
                  - name: GOOGLE_APPLICATION_CREDENTIALS
                    value: ""
                  - name: DOCKER_REGISTRY_ORG
                    value: jenkinsxio

              - name: build-jx-pod-status
                command: make build
                image: golang:1.15
                dir: /workspace/source/cmd/jx-pod-status
              - name: build-and-push-jx-pod-status
                image: gcr.io/kaniko-project/executor
                command: /kaniko/executor --context=/workspace/source/cmd/jx-pod-status --dockerfile=/workspace/source/cmd/jx-pod-status/Dockerfile --destination=gcr.io/$DOCKER_REGISTRY_ORG/jx-pod-status:$VERSION
                env:
                  - name: NO_GOOGLE_APPLICATION_CREDENTIALS
                    value: "true"
                  - name: GOOGLE_APPLICATION_CREDENTIALS
                    value: ""
                  - name: DOCKER_REGISTRY_ORG
                    value: jenkinsxio

              - name: build-jx-secrets
                command: make build
                image: golang:1.15
                dir: /workspace/source/cmd/jx-secrets
              - name: build-and-push-jx-secrets
                image: gcr.io/kaniko-project/executor
                command: /kaniko/executor --context=/workspace/source/cmd/jx-secrets --dockerfile=/workspace/source/cmd/jx-secrets/Dockerfile --destination=gcr.io/$DOCKER_REGISTRY_ORG/jx-secrets:$VERSION
                env:
                  - name: NO_GOOGLE_APPLICATION_CREDENTIALS
                    value: "true"
                  - name: GOOGLE_APPLICATION_CREDENTIALS
                    value: ""
                  - name: DOCKER_REGISTRY_ORG
                    value: jenkinsxio

              - name: changelog
                command: jx step changelog --verbose --header-file=hack/changelog-header.md --version=$VERSION --rev=$PULL_BASE_SHA --output-markdown=changelog.md --update-release=false
                image: gcr.io/jenkinsxio/jx
              - name: release-charts
                image: gcr.io/jenkinsxio/jx-cli
                command: make
                args:
                  - release
                dir: /workspace/source/charts/jx-kh-check
